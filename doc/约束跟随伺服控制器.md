# 约束跟随伺服控制器

# 1.Rosenberg嵌入法

假如一个机械系统由 $s$ 个质点或刚体组成，且可以通过广义坐标向量 $q \in \mathbb{R}^n$ 来表示该系统在任意时间 $t$ 的位移，则系统的广义速度向量为 $\dot q \in \mathbb{R}^n$，系统的广义加速度向量为 $\ddot q \in \mathbb{R}^n$。根据拉格朗日建模方法，在不受约束条件下的机械系统运动方程可表示为：

$$
\frac{d}{dt}\frac{\partial T(\dot{q},q,t)}{\partial \dot{q}} - \frac{\partial T(\dot{q},q,t)}{\partial q} - Q(\dot{q},q,t) = 0\tag
{1}
$$

式中 $Q(\dot{q},q,t)\in \mathbb{R}^n$ 为外力。$T\in R$ 为系统能量，可表示为：

$$
T(\dot{q},q,t) = \frac{1}{2}\dot{q}^T M(q,t)\dot{q} + N^T(q,t)\dot{q} + P(q,t)
\tag{2}
$$

其中，$M(q,t) \in \mathbb{R}^{n\times n}$ 为系统的质量矩阵，$N^T(q,t)\dot q\in \mathbb{R}^n$ 为系统所受到的科氏力，$P(q,t)\in \mathbb{R}^n$ 则为系统势能。联立上述 $(1)(2)$ 两式进行化简可得：

$$
M(q,t)\ddot{q} = F(\dot{q},q,t)
\tag{3}
$$

式中

$$
F(\dot{q},q,t) = -\dot M(q,t)\dot{q}-\dot N^T(q,t) + \frac{\partial T(\dot{q},q,t)}{\partial q} + Q(\dot{q},q,t) 
\tag{4}
$$

下面来推导一下这一过程：

$$
\frac{d}{dt}\frac{\partial T(\dot{q},q,t)}{\partial \dot{q}}
= \frac{d}{dt} (\frac1 2M(q,t)\dot q+\frac1 2M^T(q,t)\dot q + N^T(q,t))\\
=\frac{d}{dt} (M(q,t)\dot q+ N^T(q,t))
= \dot M(q,t)\dot{q} + M(q,t)\ddot{q} + \dot  N^T(q,t)
$$

将上式代入式$(1)$，即可得到结果。

<span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);">（注：此处推导时用到了矩阵的求导公式 </span>$\frac{\partial X^TAX}{\partial X} = (A+A^T)X$<span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);">，具体更详细的内容可以去控制之美卷2查看）</span>

若该系统受到 $l(l<n)$ 个非完整约束，其所受约束的Pfaffian(即“一阶约束”)形式可表示为：

$$
\sum_{i=1}^{n} A_ {ki} (q,t)\dot{q}_i + A_k(q,t) = 0 \quad (k=1,\ldots,l)
\tag{5}
$$

式中 $A_ {ki}$ 和 $A_k$ 满足 $C^1$。

上述式子的成立都是在两个假设的基础上，其中：

- 假设1：机械系统的质量矩阵$M$是对称正定矩阵。
- 假设2：机械系统的约束相互独立。

# 2.Udwadia-Kalaba 方程

假设不受约束的机械系统动力学模型由式 $(3)$ 表示，当系统受到 $l$ 个完整或非完整约束，表示为 Pfaffian 形式如式 $(5)$ 所示。对式 $(5)$ 进行求导，可得

到约束的二阶形式(即“二阶约束”)为：

‍

将其写为矩阵的形式为：

$$
A\ddot q=b \tag{6}
$$

式中$\mathit{A} = [A_{k_i}]_{1 \times n}, \quad \mathit{b} = [b_i]_{n \times 1}     $ 。

# 3.扩展Rosenberg 嵌入法

基于 Rosenberg 嵌入法得到的动力学模型，虽然减小了动力学模型的维度，建模过程无需辅助变量，但该模型无法分别对机械系统的 $n$ 个广义坐标变量进

行解耦和求解。为解决上述问题，我们借助约束方程的二阶形式对 Rosenberg 嵌入法进行扩展。

由于此处推导较为繁琐，直接给出最终结果。扩展后的 Rosenberg 嵌入法得到的系统加速度 $\ddot q_1$ 和 $\ddot q_2$ 为：

$$
\ddot q_1=A_1^{-1}b - KX^{-1}(F_2 + K^TM_{11}A_1^{-1}b - K^TF_1) + KX^{-1}M_{21}A_1^{-1}b\tag{7}
$$

$$
\ddot q_2=X^{-1} (F_2 + K^TM_{11}A_1^{-1}b - K^TF_1 - M_{21}A_1^{-1}b) \tag{8}
$$

# 4.三轮全向机器人的数学建模

# ![image](assets/image-20241205172942-ys3ilwd.png)

模型结构如上图所示，其中 $XY$ 坐标系是地面坐标系，$X_RY_R$ 坐标系是固定在机器人中心的局部坐标系。车轮之间的角度为 $\pi/3$。模型的质心集中在中心点 $P(x,y)$，车轮的质量集中在车轮的中心。主要参数和坐标变量如下：

- $m_1,I_1,r$：单个车轮的质量、惯性矩和半径
- $m_2,I_2,l$：质心和有效载荷（车轮除外）的质量、惯性矩和半径
- $\psi_1,\psi_2,\psi_3$：车轮的旋转角度
- $x,y,\theta$：中心体的位置和偏航角
- $r,L$：车轮和中心体的半径
- $\omega$：整体的角速度
- $\tau_{f1},\tau_{f2},\tau_{f3}$：三个轮子的驱动力，且$\tau_f=[\tau_{f1},\tau_{f2},\tau_{f3}]^T$  

  ‍

那么无约束机械系统的运动方程为：

$$
M\ddot q=F+B\tau_f \tag{9}
$$

其中$B=[0_{3\times3},I_{3\times3}]$，用于调整 $\tau_f$ 的维数，$M =diag(I_1; I_1; I_1; 3m_1 + m_2; 3m_1 + m_2; 3m_1l^2 + I_2) $，$-\dot M\dot{q}-\dot N^T + \frac{\partial T}{\partial q}=0$，$F=Q$。

假设作用在系统上的外力只有摩擦力，根据摩擦理论，总力Q为：

$$
Q = \begin{bmatrix}
-\text{sgn}(\psi_1)f_1g(m_1 + \frac{1}{2}m_2)r \\
-\text{sgn}(\psi_2)f_1g(m_1 + \frac{1}{2}m_2)r \\
-\text{sgn}(\psi_3)f_1g(m_1 + \frac{1}{2}m_2)r \\
-\text{sgn}(x)\Theta_1 \\
-\text{sgn}(y)\Theta_2 \\
0
\end{bmatrix}
$$

> <span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);">（注：关于 </span>$Q$<span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);"> 更详细的内容可以去论文中看，此处 </span>$\Theta_1$<span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);"> 与 </span>$\Theta_2$<span data-type="text" style="background-color: var(--b3-card-error-background); color: var(--b3-card-error-color);"> 应该是不相等的，有兴趣可以自行推导一下。）</span>

在[Omni机器人数学建模](Omni机器人数学建模.md)中我们得到了机器人地面坐标 $XY$ 坐标系下的运动学方程，将该方程改写为 $A \ddot q=b$ 的形式：

$$
A\ddot{q} := \begin{bmatrix}
-r & 0 & 0 & \sin(\theta + \pi/3) & -\cos(\theta + \pi/3) & -L \\
0 & -r & 0 & -\sin\theta & \cos\theta & -L \\
0 & 0 & -r & \sin(\theta - \pi/3) & -\cos(\theta - \pi/3) & -L
\end{bmatrix} \ddot{q} \\
= \begin{bmatrix}
-\dot{x}\theta\cos(\theta + \pi/3) - \dot{y}\theta\sin(\theta + \pi/3) \\
\dot{x}\theta\cos\theta + \dot{y}\theta\sin\theta \\
-\dot{x}\theta\cos(\theta - \pi/3) - \dot{y}\theta\sin(\theta - \pi/3)
\end{bmatrix} := b
$$

那么根据上述理论、引理等，机器人的数学模型可以写成：

$$
\ddot q_1=A_1^{-1}b - KX^{-1}\big(F_2 + K^TM_{11}A_1^{-1}b - K^T(F_1+\tau_f)\big)
\tag{10}
$$

$$
\ddot q_2=X^{-1} \big(F_2 + K^TM_{11}A_1^{-1}b - K^T(F_1+\tau_f)\big) \tag{11}
$$

其中 $M_{11}=diag(I_1,I_1,I_1),M_{22}=diag(3m_1 + m_2; 3m_1 + m_2; 3m_1l^2 + I_2),M_{21}=M_{12}=0_{3\times3},K = A_1^{-1}A_2, X = K^TM_{11}K + M_{22}$  

# 5.约束跟随伺服控制器

假设机器人的期望轨迹是 $q_2^d=[x^d,y^d,\theta^d]^T$ ，那么期望速度为 $\dot q_2^d$ ，期望加速度为 $\ddot q_2^d$ ，机器人的实际轨迹与期望轨迹之间的误差可以表示为：

$$
e=[e_x,e_y,e_\theta]^T=q_2-q_2^d \tag{12}
$$

同样误差的导数可定义为：

$$
\dot e=\dot q_2-\dot q_2^d \tag{13}
$$

$$
\ddot e=\ddot q_2-\ddot q_2^d \tag{14}
$$

要使机器人沿着期望的轨迹运行，那么误差 $e$ 一定是要收敛的，画出 $\dot e$ 和 $e$ 的相平面可以看出，如果要让误差收敛，那么点 $(\dot e,e)$ 只能在第二象限或第四象限，据此我们令：

$$
\dot e +Se=0 \tag{15}
$$

$$
\ddot e+S\dot e=0 \tag{16}
$$

将式 $(13)、(14)$ 代入到式 $(16)$ 中，可以得到：

$$
\ddot q_2=\ddot q_2^d +S\dot q_2^d - S\dot q_2 \tag{17}
$$

将式 $(17)$ 代入到式 $(11)$ 中，我们就得到了 $\tau_f$ 的表达式：

$$
\tau_f=(K^T)^+\big(F_2+K^TM_{11}A_1^{-1}b-X(\ddot q_2^d +S\dot q_2^d - S\dot q_2)\big)-F_1
\tag{18}
$$

> （注：设 $A \in \mathbb{C}^{m\times n}$ ，如果存在矩阵 $B \in \mathbb{C}^{m\times n}$ ，满足摩尔-彭罗斯（Moore-Penrose）方程
>
> $$
> (I)ABA=A
> $$
>
> $$
> (II)BAB=B
> $$
>
> $$
> (III)(AB)^H=AB
> $$
>
> $$
> (IV)(BA)^H=BA
> $$
>
> 的一部分或全部，则称 $B$ 为 $A$ 的广义逆矩阵。
>
> 满足方程 $(I)$ 的广义逆矩阵，记为$A^{-1}$ ；满足方程 $(I)、(II)$ 的广义逆矩阵，成为自反广义逆矩阵，记为 $A_r^{-1}$ ；满足全部方程的广义逆矩阵，称为伪逆矩阵，记为 $A^+$。）

至此，我们得到了控制量 $\tau_f$ 中最主要的一项：

$$
p_1 =(K^T)^+\big(F_2+K^TM_{11}A_1^{-1}b-X(\ddot q_2^d +S\dot q_2^d - S\dot q_2)\big)-F_1
\tag{19}
$$

在论文中，控制量 $\tau_f=p_1+p_2+p_3+p_4$ ，$p_2$ 为反馈控制，$p_3$ 为自适应控制，$p_4$ 为输出（转矩）限幅控制，详细内容可去论文中查看，此处不做解释。

参考内容：

- Modeling and Tracking Control of the Omnidirectional Robot in Narrow Spaces with Uncertainty
- 非完整机械系统动力学建模的 Rosenberg 嵌入法
- UK与伺服约束跟随控制方法总结

‍
